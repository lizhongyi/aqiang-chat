<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>随机匹配聊天</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>


    <link rel="stylesheet" href="/css/index.css">


</head>

<body class="bg-gray-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- 语言选择器 -->
        <div class="flex justify-end mb-4">
            <div class="language-selector">
                <button id="language-btn"
                    class="flex items-center gap-2 bg-white px-3 py-1 rounded-md shadow-sm text-sm">
                    <i class="fa fa-globe text-primary"></i>
                    <span id="current-language">中文</span>
                    <i class="fa fa-chevron-down text-xs"></i>
                </button>
                <div id="language-dropdown" class="language-dropdown hidden">
                    <div class="language-option active" data-lang="zh-TW">繁体中文</div>
                    <div class="language-option " data-lang="zh-CN">简体中文</div>
                    <div class="language-option" data-lang="en">English</div>
                    <div class="language-option" data-lang="ja">日本語</div>
                    <div class="language-option" data-lang="ko">한국어</div>
                </div>
            </div>
        </div>

        <!-- 头部 -->
        <header class="text-center mb-8">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-dark mb-2" data-i18n="header.title">随机匹配聊天</h1>
            <p class="text-gray-600" data-i18n="header.subtitle">与陌生人匿名交流，分享你的想法</p>
        </header>

        <!-- 主要内容区 -->
        <main class="flex flex-col lg:flex-row gap-6">
            <!-- 左侧：用户信息、匹配状态和聊天区域 -->
            <div class="lg:w-2/3">
                <!-- 用户信息输入面板 -->
                <div id="user-info-panel" class="bg-white rounded-xl shadow-md p-6 mb-6 text-center">
                    <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gray-200 flex items-center justify-center">
                        <i class="fa fa-user text-4xl text-gray-500"></i>
                    </div>
                    <h2 class="text-xl font-semibold mb-4" data-i18n="userInfo.title">请完善你的信息</h2>
                    <div class="max-w-xs mx-auto">
                        <!-- 昵称输入 -->
                        <input type="text" id="nickname-input" placeholder="例如：阳光男孩、快乐小天使"
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                            data-i18n-placeholder="userInfo.placeholder">

                        <!-- 自身性别选择 -->
                        <div class="mb-6">
                            <p class="text-sm text-gray-500 mb-3 text-left" data-i18n="userInfo.myGender">你的性别：</p>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="gender-option border rounded-lg px-3 py-2 text-center" data-gender="male">
                                    <i class="fa fa-mars block mb-1"></i>
                                    <span data-i18n="userInfo.genderMale">男性</span>
                                </div>
                                <div class="gender-option border rounded-lg px-3 py-2 text-center" data-gender="female">
                                    <i class="fa fa-venus block mb-1"></i>
                                    <span data-i18n="userInfo.genderFemale">女性</span>
                                </div>
                                <div class="gender-option selected border rounded-lg px-3 py-2 text-center"
                                    data-gender="unknown">
                                    <i class="fa fa-question block mb-1"></i>
                                    <span data-i18n="userInfo.genderUnknown">保密</span>
                                </div>
                            </div>
                        </div>

                        <!-- 匹配性别偏好选择 -->
                        <div class="mb-6">
                            <p class="text-sm text-gray-500 mb-3 text-left" data-i18n="userInfo.genderPreference">
                                希望匹配的性别：</p>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="gender-option selected border rounded-lg px-3 py-2 text-center"
                                    data-preference="any">
                                    <i class="fa fa-asterisk block mb-1"></i>
                                    <span data-i18n="userInfo.preferenceAny">不限</span>
                                </div>
                                <div class="gender-option border rounded-lg px-3 py-2 text-center"
                                    data-preference="male">
                                    <i class="fa fa-mars block mb-1"></i>
                                    <span data-i18n="userInfo.preferenceMale">男性</span>
                                </div>
                                <div class="gender-option border rounded-lg px-3 py-2 text-center"
                                    data-preference="female">
                                    <i class="fa fa-venus block mb-1"></i>
                                    <span data-i18n="userInfo.preferenceFemale">女性</span>
                                </div>
                            </div>
                        </div>

                        <p class="text-sm text-gray-500 mb-4" data-i18n="userInfo.hint">信息仅用于匹配，不会公开显示</p>
                        <button id="start-chat-btn"
                            class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition duration-300 w-full"
                            data-i18n="userInfo.button">
                            开始匹配聊天
                        </button>
                    </div>
                </div>

                <!-- 匹配状态面板 -->
                <div id="match-panel" class="hidden bg-white rounded-xl shadow-md p-6 mb-6 text-center">
                    <div
                        class="w-16 h-16 mx-auto mb-4 border-4 border-primary border-t-transparent rounded-full animate-spin">
                    </div>
                    <h2 class="text-xl font-semibold mb-2" data-i18n="match.status">正在寻找聊天对象...</h2>
                    <p class="text-gray-600 mb-4" data-i18n="match.hint">请稍候，我们正在为你匹配合适的聊天伙伴</p>
                    <button id="cancel-match"
                        class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition duration-300"
                        data-i18n="match.cancel">
                        取消匹配
                    </button>
                </div>

                <!-- 聊天面板（默认隐藏） -->
                <div id="chat-panel" class="hidden bg-white rounded-xl shadow-md overflow-hidden">
                    <!-- 聊天头部 -->
                    <div class="bg-primary text-white p-4 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center">
                                <i class="fa fa-user text-gray-700"></i>
                            </div>
                            <span id="partner-nickname" data-i18n="chat.partner">匿名聊天伙伴</span>
                        </div>
                        <div class="flex gap-3">
                            <button id="history-btn" class="text-white hover:text-gray-200 transition" title="聊天历史">
                                <i class="fa fa-history"></i>
                            </button>
                            <button id="clear-history-btn" class="text-white hover:text-gray-200 transition"
                                title="清除历史">
                                <i class="fa fa-trash"></i>
                            </button>
                            <button id="end-chat" class="text-white hover:text-red-200 transition" title="结束聊天">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 聊天历史记录面板（默认隐藏） -->
                    <div id="history-panel" class="hidden bg-gray-50 p-4 border-b">
                        <h3 class="font-semibold mb-2" data-i18n="history.title">聊天历史</h3>
                        <div id="history-list" class="max-h-32 overflow-y-auto space-y-2 text-sm">
                            <!-- 历史记录会动态添加到这里 -->
                        </div>
                        <button id="close-history" class="mt-2 text-primary text-sm hover:underline"
                            data-i18n="history.close">关闭历史</button>
                    </div>

                    <!-- 聊天内容区 -->
                    <div id="chat-messages" class="h-[400px] p-4 overflow-y-auto scrollbar-hide space-y-4">
                        <!-- 消息会动态添加到这里 -->
                        <div id="typing-indicator" class="hidden flex justify-start">
                            <div
                                class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0 mt-1 mr-2">
                                <i class="fa fa-user text-gray-700"></i>
                            </div>
                            <div class="typing-indicator">
                                <span id="typing-text" data-i18n="chat.typing">对方正在输入...</span>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 输入区 -->
                    <div class="border-t p-4">
                        <div class="flex gap-2 mb-2">
                            <button id="emoji-btn" class="text-gray-600 hover:text-primary transition p-2" title="表情">
                                <i class="fa fa-smile-o text-xl"></i>
                            </button>
                            <label for="image-upload"
                                class="text-gray-600 hover:text-primary transition p-2 cursor-pointer" title="上传图片">
                                <i class="fa fa-picture-o text-xl"></i>
                            </label>
                            <input id="image-upload" type="file" accept="image/*" class="hidden">
                            <div class="ml-auto text-xs text-gray-500 flex items-center">
                                <i class="fa fa-clipboard mr-1"></i>
                                <span data-i18n="chat.pasteHint">支持粘贴图片 (Ctrl+V)</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="message-input" placeholder="输入消息... 可粘贴图片(Ctrl+V)"
                                class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                data-i18n-placeholder="chat.inputPlaceholder">
                            <button id="send-btn"
                                class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition"
                                data-i18n="chat.sendBtn">
                                <i class="fa fa-paper-plane"></i>
                            </button>
                        </div>
                        <!-- 上传进度条 -->
                        <div id="upload-progress-container" class="hidden upload-progress">
                            <div id="progress-bar" class="progress-bar"></div>
                        </div>
                        <!-- 粘贴提示（默认隐藏） -->
                        <div id="paste-notification"
                            class="hidden mt-2 text-sm text-green-600 flex items-center justify-center paste-hint">
                            <i class="fa fa-check-circle mr-1"></i>
                            <span data-i18n="chat.pasteSuccess">图片已准备好，点击发送</span>
                        </div>
                        <!-- 上传错误提示 -->
                        <div id="upload-error"
                            class="hidden mt-2 text-sm text-red-600 flex items-center justify-center">
                            <i class="fa fa-exclamation-circle mr-1"></i>
                            <span id="error-message" data-i18n="chat.uploadError">图片上传失败，请重试</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：聊天规则和提示 -->
            <div class="lg:w-1/3">
                <div class="bg-white rounded-xl shadow-md p-6 h-full">
                    <h3 class="text-lg font-semibold mb-4 text-primary" data-i18n="rules.title">聊天规则</h3>
                    <ul class="space-y-2 text-gray-700 mb-6">
                        <li class="flex items-start gap-2">
                            <i class="fa fa-check-circle text-secondary mt-1"></i>
                            <span data-i18n="rules.rule1">保持友好和尊重的交流态度</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fa fa-check-circle text-secondary mt-1"></i>
                            <span data-i18n="rules.rule2">禁止发送违法或不适当内容</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fa fa-check-circle text-secondary mt-1"></i>
                            <span data-i18n="rules.rule3">保护个人隐私，不要分享敏感信息</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fa fa-check-circle text-secondary mt-1"></i>
                            <span data-i18n="rules.rule4">如遇不当内容，可随时结束聊天</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fa fa-check-circle text-secondary mt-1"></i>
                            <span data-i18n="rules.rule5">聊天记录保存在本地，不会上传到服务器</span>
                        </li>
                    </ul>

                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium text-primary mb-2" data-i18n="shortcuts.title">快捷操作</h4>
                        <p class="text-sm text-gray-600 mb-2" data-i18n="shortcuts.paste">•
                            粘贴图片：使用Ctrl+V（Windows）或Cmd+V（Mac）</p>
                        <p class="text-sm text-gray-600" data-i18n="shortcuts.send">• 发送消息：按Enter键</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- 页脚 -->
        <footer class="mt-12 text-center text-gray-500 text-sm" data-i18n="footer.copyright">
            随机匹配聊天 © 2023 - 保持友好交流
        </footer>
    </div>

    <!-- 表情选择器（默认隐藏） -->
    <div id="emoji-picker" class="hidden fixed bg-white rounded-lg shadow-lg p-3 z-50">
        <div class="grid grid-cols-7 gap-2">
            <!-- 表情会动态添加到这里 -->
        </div>
    </div>


    <!-- 在body结束前添加图片预览模态框 -->
    <div id="image-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
        <button id="close-modal"
            class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300 transition-colors">
            <i class="fa fa-times"></i>
        </button>
        <img id="modal-image" src="" alt="放大查看"
            class="max-w-full max-h-[90vh] object-contain transition-all duration-300">
    </div>

    <script src="/js/i18n.js"></script>

    <script>


        // DOM元素
        const userInfoPanel = document.getElementById('user-info-panel');
        const nicknameInput = document.getElementById('nickname-input');
        const startChatBtn = document.getElementById('start-chat-btn');
        const matchPanel = document.getElementById('match-panel');
        const chatPanel = document.getElementById('chat-panel');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const cancelMatchBtn = document.getElementById('cancel-match');
        const endChatBtn = document.getElementById('end-chat');
        const emojiBtn = document.getElementById('emoji-btn');
        const emojiPicker = document.getElementById('emoji-picker');
        const imageUpload = document.getElementById('image-upload');
        const historyBtn = document.getElementById('history-btn');
        const historyPanel = document.getElementById('history-panel');
        const historyList = document.getElementById('history-list');
        const closeHistoryBtn = document.getElementById('close-history');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const partnerNickname = document.getElementById('partner-nickname');
        const pasteNotification = document.getElementById('paste-notification');
        const uploadProgressContainer = document.getElementById('upload-progress-container');
        const progressBar = document.getElementById('progress-bar');
        const uploadError = document.getElementById('upload-error');
        const errorMessage = document.getElementById('error-message');
        const typingIndicator = document.getElementById('typing-indicator');
        const typingText = document.getElementById('typing-text');
        const languageBtn = document.getElementById('language-btn');
        const currentLanguage = document.getElementById('current-language');
        const languageDropdown = document.getElementById('language-dropdown');
        const languageOptions = document.querySelectorAll('.language-option');
        const genderOptions = document.querySelectorAll('[data-gender]');
        const preferenceOptions = document.querySelectorAll('[data-preference]');

        // 聊天相关变量
        let socket;
        let isConnected = false;
        let currentChatId = null; // 当前聊天会话ID
        let userNickname = '';    // 当前用户昵称
        let userGender = 'unknown'; // 用户自身性别，默认为保密
        let genderPreference = 'any'; // 性别匹配偏好，默认为不限
        let pendingImage = null;  // 待发送的图片URL
        let typingTimer = null;   // 输入定时器
        let isTyping = false;     // 是否正在输入
        const TYPING_DELAY = 1000; // 输入状态发送间隔(ms)
        const TYPING_TIMEOUT = 2000; // 输入状态超时时间(ms)
        let typingTimeoutTimer = null; // 输入状态超时定时器
        const STORAGE_KEY = 'chat_history'; // 本地存储键名
        let currentLang = 'zh-CN'; // 默认语言

        // 设置语言
        function setLanguage(lang) {
            if (!languages[lang]) return;

            currentLang = lang;

            // 更新当前语言显示
            currentLanguage.textContent = languageNames[lang] || lang;

            // 更新语言选项的活跃状态
            languageOptions.forEach(option => {
                if (option.dataset.lang === lang) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });

            // 翻译页面元素
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (languages[lang][key]) {
                    el.textContent = languages[lang][key];
                }
            });

            // 翻译占位符
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (languages[lang][key]) {
                    el.placeholder = languages[lang][key];
                }
            });

            // 保存用户语言偏好
            localStorage.setItem('preferred_language', lang);

            // 更新动态内容
            updateDynamicContent();
        }

        // 更新动态内容的翻译
        function updateDynamicContent() {
            // 更新历史记录中的文本
            if (historyList.innerHTML.includes('暂无聊天历史')) {
                historyList.innerHTML = `<p class="text-gray-500" data-i18n="system.noHistory">${languages[currentLang]['system.noHistory']}</p>`;
            }
        }

        // 初始化WebSocket连接
        function initWebSocket() {
            // 连接本地WebSocket服务器
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUri = `${wsProtocol}//${window.location.host}/ws`;

            socket = new WebSocket(wsUri);

            socket.onopen = function () {
                console.log('WebSocket连接已建立');
                isConnected = true;
            };

            socket.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (error) {
                    console.error('解析消息失败:', error, '消息内容:', event.data);
                }
            };

            socket.onclose = function () {
                console.log('WebSocket连接已关闭');
                isConnected = false;
                // 尝试重连
                setTimeout(initWebSocket, 3000);
            };

            socket.onerror = function (error) {
                console.error('WebSocket错误:', error);
            };
        }
        // 添加消息到聊天区域（修复insertBefore报错）
        function addMessage(content, isOwn, isImage = false, senderNickname) {
            // 添加消息前先隐藏正在输入提示
            if (!isOwn) {
                hideTypingIndicator();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} gap-2`;

            // 添加头像
            const avatarDiv = document.createElement('div');
            avatarDiv.className = `w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0 mt-1`;
            avatarDiv.innerHTML = `<i class="fa fa-user text-gray-700"></i>`;

            // 消息气泡
            const bubbleContainer = document.createElement('div');
            bubbleContainer.className = 'flex flex-col max-w-[70%]';

            // 发送者昵称（仅显示对方的）
            if (!isOwn && senderNickname) {
                const nicknameDiv = document.createElement('div');
                nicknameDiv.className = 'text-xs text-gray-500 mb-1 ml-1';
                nicknameDiv.textContent = senderNickname;
                bubbleContainer.appendChild(nicknameDiv);
            }

            const bubbleClass = isOwn
                ? 'bg-primary text-white rounded-t-lg rounded-bl-lg'
                : 'bg-gray-200 text-gray-800 rounded-t-lg rounded-br-lg';

            const messageContent = document.createElement('div');
            messageContent.className = `${bubbleClass} px-4 py-2`;

            if (isImage) {
                // 构建完整的图片URL
                const imageUrl = content.startsWith('http') ? content : `${window.location.origin}${content}`;
                messageContent.innerHTML = `<img src="${imageUrl}" alt="聊天图片" class=" chat-image rounded max-w-full h-auto">`;
            } else {
                messageContent.textContent = content;
            }

            bubbleContainer.appendChild(messageContent);

            // 组装消息元素
            if (isOwn) {
                messageDiv.appendChild(bubbleContainer);
                messageDiv.appendChild(avatarDiv);
            } else {
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(bubbleContainer);
            }

            // 核心修复：先检查typing-indicator是否存在于chatMessages中
            if (chatMessages.contains(typingIndicator)) {
                // 存在则插入到typing-indicator前
                chatMessages.insertBefore(messageDiv, typingIndicator);
            } else {
                // 不存在则直接添加到末尾，并重新把typing-indicator加回DOM（防止后续报错）
                chatMessages.appendChild(messageDiv);
                chatMessages.appendChild(typingIndicator);
            }

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }


        //保存聊天匹配信息到本地存储
        function saveChatMatchInfo(chatId, partnerNickname) {
            const chatMatchInfo = {
                chatId,
                partnerNickname,
                timestamp: Date.now()
            };
            localStorage.setItem('chatMatchInfo', JSON.stringify(chatMatchInfo));
        }

        //清楚本地聊天匹配信息
        function clearChatMatchInfo() {
            localStorage.removeItem('chatMatchInfo');
        }
        // 处理接收到的消息
        function handleMessage(data) {
            console.log('收到消息:', data);

            switch (data.type) {
                case 'match_found':
                    // 匹配成功，显示聊天面板
                    matchPanel.classList.add('hidden');
                    chatPanel.classList.remove('hidden');
                    currentChatId = data.chatId || generateChatId();

                    // 显示聊天伙伴昵称
                    const partnerName = data.partnerNickname && data.partnerNickname.trim()
                        ? data.partnerNickname
                        : languages[currentLang]['chat.partner'];

                    partnerNickname.textContent = partnerName;
                    // 使用国际化消息
                    const matchFoundMsg = languages[currentLang]['system.matchFound'].replace('{name}', partnerName);
                    addSystemMessage(matchFoundMsg);

                    // 加载当前会话的历史记录（如果有）
                    loadChatHistory(currentChatId);
                    saveChatMatchInfo(currentChatId, partnerName);
                    break;

                case 'message':
                    // 收到消息时隐藏正在输入提示
                    hideTypingIndicator();

                    // 收到消息
                    addMessage(data.content, false, data.isImage, data.senderNickname);
                    // 保存到本地存储
                    saveMessageToHistory(currentChatId, data.content, false, data.isImage, data.senderNickname);
                    break;

                case 'typing':
                    // 处理对方正在输入状态
                    if (data.chatId === currentChatId) {
                        if (data.isTyping) {
                            showTypingIndicator();
                        } else {
                            hideTypingIndicator();
                        }
                    }
                    break;

                case 'user_disconnected':
                    // 对方断开连接，隐藏正在输入提示
                    hideTypingIndicator();

                    // 对方断开连接，使用国际化消息
                    const partnerLeftMsg = languages[currentLang]['system.partnerLeft'].replace('{name}', partnerNickname.textContent);
                    addSystemMessage(partnerLeftMsg);
                    sendBtn.disabled = true;
                    messageInput.disabled = true;
                    break;

                case 'system':
                    // 系统消息，隐藏正在输入提示
                    hideTypingIndicator();

                    // 系统消息
                    addSystemMessage(data.content);
                    break;
            }
        }

        // 发送消息（支持文本和图片）
        function sendMessage(content, isImage = false) {
            if (!isConnected || !currentChatId) return;

            // 发送消息时，通知对方已停止输入
            sendTypingStatus(false);

            // 如果有 pendingImage，优先发送图片
            if (pendingImage) {
                const message = {
                    type: 'message',
                    content: pendingImage,
                    isImage: true,
                    chatId: currentChatId,
                    senderNickname: userNickname
                };

                socket.send(JSON.stringify(message));
                addMessage(pendingImage, true, true, userNickname);
                saveMessageToHistory(currentChatId, pendingImage, true, true, userNickname);

                // 清除 pendingImage 和通知
                pendingImage = null;
                pasteNotification.classList.add('hidden');
                return;
            }

            // 发送文本消息
            if (content.trim()) {
                const message = {
                    type: 'message',
                    content: content,
                    isImage: isImage,
                    chatId: currentChatId,
                    senderNickname: userNickname
                };

                socket.send(JSON.stringify(message));
                addMessage(content, true, isImage, userNickname);
                saveMessageToHistory(currentChatId, content, true, isImage, userNickname);
                messageInput.value = '';
            }
        }

        // 添加系统消息（修复insertBefore报错）
        function addSystemMessage(content) {
            // 隐藏正在输入提示
            hideTypingIndicator();

            const systemDiv = document.createElement('div');
            systemDiv.className = 'text-center';

            const messageContent = document.createElement('div');
            messageContent.className = 'inline-block bg-gray-100 text-gray-500 text-sm px-3 py-1 rounded-full';
            messageContent.textContent = content;

            systemDiv.appendChild(messageContent);

            // 核心修复：先检查typing-indicator是否存在
            if (chatMessages.contains(typingIndicator)) {
                chatMessages.insertBefore(systemDiv, typingIndicator);
            } else {
                chatMessages.appendChild(systemDiv);
                chatMessages.appendChild(typingIndicator);
            }

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 添加系统消息（修复insertBefore报错）
        function addSystemMessage(content) {
            // 隐藏正在输入提示
            hideTypingIndicator();

            const systemDiv = document.createElement('div');
            systemDiv.className = 'text-center';

            const messageContent = document.createElement('div');
            messageContent.className = 'inline-block bg-gray-100 text-gray-500 text-sm px-3 py-1 rounded-full';
            messageContent.textContent = content;

            systemDiv.appendChild(messageContent);

            // 核心修复：先检查typing-indicator是否存在
            if (chatMessages.contains(typingIndicator)) {
                chatMessages.insertBefore(systemDiv, typingIndicator);
            } else {
                chatMessages.appendChild(systemDiv);
                chatMessages.appendChild(typingIndicator);
            }

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 显示正在输入提示
        function showTypingIndicator() {
            // 更新提示文本（国际化）
            typingText.textContent = languages[currentLang]['chat.typing'];

            // 显示提示
            typingIndicator.classList.remove('hidden');

            // 重置超时计时器
            clearTimeout(typingTimeoutTimer);
            typingTimeoutTimer = setTimeout(() => {
                hideTypingIndicator();
            }, TYPING_TIMEOUT);

            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 隐藏正在输入提示
        function hideTypingIndicator() {
            typingIndicator.classList.add('hidden');
            clearTimeout(typingTimeoutTimer);
        }

        // 发送输入状态
        function sendTypingStatus(status) {
            if (!isConnected || !currentChatId || isTyping === status) return;

            isTyping = status;

            socket.send(JSON.stringify({
                type: 'typing',
                isTyping: status,
                chatId: currentChatId
            }));
        }

        // 处理输入事件，发送正在输入状态
        function handleInput() {
            // 如果有图片待发送，则不发送输入状态
            if (pendingImage) return;

            // 清除之前的定时器
            clearTimeout(typingTimer);

            // 如果之前没有发送过正在输入状态，则立即发送
            if (!isTyping) {
                sendTypingStatus(true);
            }

            // 设置定时器，延迟一段时间后发送停止输入状态
            typingTimer = setTimeout(() => {
                sendTypingStatus(false);
            }, TYPING_TIMEOUT);
        }

        // 本地存储相关函数
        function getChatHistory() {
            const history = localStorage.getItem(STORAGE_KEY);
            return history ? JSON.parse(history) : {};
        }

        function saveChatHistory(history) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        }

        function saveMessageToHistory(chatId, content, isOwn, isImage, senderNickname) {
            const history = getChatHistory();

            if (!history[chatId]) {
                history[chatId] = {
                    timestamp: new Date().toISOString(),
                    partnerNickname: partnerNickname.textContent,
                    messages: []
                };
            }

            history[chatId].messages.push({
                content: content,
                isOwn: isOwn,
                isImage: isImage,
                senderNickname: senderNickname,
                timestamp: new Date().toISOString()
            });

            saveChatHistory(history);
        }

        function loadChatHistory(chatId) {
            const history = getChatHistory();
            const chatHistory = history[chatId];

            if (chatHistory && chatHistory.messages.length > 0) {
                // 使用国际化消息
                addSystemMessage(languages[currentLang]['system.loadingHistory']);

                chatHistory.messages.forEach(msg => {
                    addMessage(msg.content, msg.isOwn, msg.isImage, msg.senderNickname);
                });

                // 使用国际化消息
                addSystemMessage(languages[currentLang]['system.historyLoaded']);
            }
        }

        function showChatHistoryList() {
            const history = getChatHistory();
            historyList.innerHTML = '';

            const chatSessions = Object.entries(history).map(([id, data]) => ({
                id,
                ...data
            })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (chatSessions.length === 0) {
                historyList.innerHTML = `<p class="text-gray-500" data-i18n="system.noHistory">${languages[currentLang]['system.noHistory']}</p>`;
                return;
            }

            chatSessions.forEach(session => {
                const item = document.createElement('div');
                item.className = 'p-2 border-b border-gray-100 last:border-0 hover:bg-gray-100 rounded cursor-pointer';

                const date = new Date(session.timestamp);
                const formattedDate = date.toLocaleString();

                const lastMessage = session.messages[session.messages.length - 1];
                let messagePreview = lastMessage.isImage ? '[图片]' :
                    lastMessage.content.length > 20 ?
                        lastMessage.content.substring(0, 20) + '...' :
                        lastMessage.content;

                item.innerHTML = `
                    <div class="font-medium text-sm">与 ${session.partnerNickname} 的聊天</div>
                    <div class="text-xs text-gray-500">${formattedDate}</div>
                    <div class="text-xs">${lastMessage.isOwn ? '你: ' : session.partnerNickname + ': '}${messagePreview}</div>
                `;

                item.addEventListener('click', () => {
                    if (currentChatId && currentChatId !== session.id) {
                        endChat();
                    }

                    currentChatId = session.id;
                    partnerNickname.textContent = session.partnerNickname;
                    userInfoPanel.classList.add('hidden');
                    matchPanel.classList.add('hidden');
                    chatPanel.classList.remove('hidden');
                    chatMessages.innerHTML = '';
                    loadChatHistory(currentChatId);
                    historyPanel.classList.add('hidden');
                });

                historyList.appendChild(item);
            });
        }

        function clearAllChatHistory() {
            // 使用自定义确认对话框
            showCustomConfirm(languages[currentLang]['system.clearHistoryConfirm'], () => {
                localStorage.removeItem(STORAGE_KEY);
                showChatHistoryList();
                addSystemMessage('所有聊天历史已清除');
            });
        }

        function generateChatId() {
            return Math.random().toString(36).substring(2, 15) +
                Math.random().toString(36).substring(2, 15);
        }











        // 开始匹配流程
        function startMatching() {
            const nickname = nicknameInput.value.trim();
            if (!nickname) {
                showCustomAlert('', languages[currentLang]['userInfo.title']); // 使用自定义提示框
                return;
            }

            userNickname = nickname;
            userInfoPanel.classList.add('hidden');
            matchPanel.classList.remove('hidden');

            // 如果用户选择了特定的匹配偏好，显示提示信息
            if (genderPreference !== 'any') {
                addSystemMessageToMatchPanel(languages[currentLang]['system.matchingInfo']);
            }

            if (isConnected) {
                socket.send(JSON.stringify({
                    type: 'match_request',
                    nickname: userNickname,
                    gender: userGender,
                    genderPreference: genderPreference
                }));
            }
        }

        // 向匹配面板添加系统消息
        function addSystemMessageToMatchPanel(content) {
            const existingMessage = matchPanel.querySelector('.system-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message text-sm text-gray-500 mt-4';
            messageDiv.innerHTML = `<i class="fa fa-info-circle mr-1 text-primary"></i>${content}`;

            matchPanel.appendChild(messageDiv);
        }

        // 取消匹配
        function cancelMatch() {
            if (isConnected) {
                socket.send(JSON.stringify({ type: 'cancel_match' }));
            }

            // 移除系统消息
            const systemMessage = matchPanel.querySelector('.system-message');
            if (systemMessage) {
                systemMessage.remove();
            }

            matchPanel.classList.add('hidden');
            userInfoPanel.classList.remove('hidden');
        }

        // 结束聊天（修复：清空内容时保留typing-indicator）
        function endChat() {
            // 发送停止输入状态
            sendTypingStatus(false);

            if (isConnected) {
                socket.send(JSON.stringify({ type: 'end_chat', chatId: currentChatId }));
            }

            // 重置状态：清空聊天内容但保留typing-indicator（关键修改）
            chatPanel.classList.add('hidden');
            userInfoPanel.classList.remove('hidden');

            // 遍历删除子节点，遇到typing-indicator则跳过（保留）
            while (chatMessages.firstChild) {
                if (chatMessages.firstChild === typingIndicator) {
                    break; // 保留typing-indicator，不删除
                }
                chatMessages.removeChild(chatMessages.firstChild);
            }

            // 其他状态重置（保持不变）
            sendBtn.disabled = false;
            messageInput.disabled = false;
            currentChatId = null;
            pendingImage = null;
            pasteNotification.classList.add('hidden');
            uploadProgressContainer.classList.add('hidden');
            uploadError.classList.add('hidden');
            hideTypingIndicator();
        }



        // 上传图片到服务器
        function uploadImageToServer(file) {
            return new Promise((resolve, reject) => {
                // 显示进度条
                uploadProgressContainer.classList.remove('hidden');
                progressBar.style.width = '0%';
                uploadError.classList.add('hidden');

                // 上传图片时发送停止输入状态
                sendTypingStatus(false);

                const formData = new FormData();
                formData.append('image', file);

                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/upload', true);

                // 监听上传进度
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        progressBar.style.width = `${percent}%`;
                    }
                });

                xhr.onload = () => {
                    // 隐藏进度条
                    uploadProgressContainer.classList.add('hidden');

                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.success && response.imageUrl) {
                                resolve(response.imageUrl);
                            } else {
                                reject(new Error(response.message || languages[currentLang]['chat.uploadError']));
                            }
                        } catch (error) {
                            reject(new Error(languages[currentLang]['chat.uploadError']));
                        }
                    } else {
                        reject(new Error(languages[currentLang]['chat.uploadError']));
                    }
                };

                xhr.onerror = () => {
                    uploadProgressContainer.classList.add('hidden');
                    reject(new Error(languages[currentLang]['chat.uploadError']));
                };

                xhr.send(formData);
            });
        }

        // 处理图片上传
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 简单验证文件类型
            if (!file.type.startsWith('image/')) {
                showUploadError(languages[currentLang]['chat.uploadError']);
                return;
            }

            try {
                // 上传图片到服务器
                const imageUrl = await uploadImageToServer(file);

                // 将图片设置为待发送状态
                pendingImage = imageUrl;

                // 显示通知
                pasteNotification.classList.remove('hidden');

                // 3秒后自动隐藏通知
                setTimeout(() => {
                    pasteNotification.classList.add('hidden');
                }, 3000);
            } catch (error) {
                showUploadError(error.message);
            } finally {
                // 重置文件输入，允许重复选择同一文件
                imageUpload.value = '';
            }
        }

        // 处理剪切板粘贴
        async function handlePaste(event) {
            // 只有在聊天面板显示时才处理粘贴
            if (chatPanel.classList.contains('hidden')) return;

            const items = (event.clipboardData || event.originalEvent.clipboardData).items;

            // 检查粘贴内容中是否有图片
            for (let item of items) {
                if (item.kind === 'file') {
                    const file = item.getAsFile();

                    // 检查是否为图片文件
                    if (file.type.startsWith('image/')) {
                        event.preventDefault(); // 阻止默认粘贴行为

                        try {
                            // 上传图片到服务器
                            const imageUrl = await uploadImageToServer(file);

                            // 将图片设置为待发送状态
                            pendingImage = imageUrl;

                            // 显示通知
                            pasteNotification.classList.remove('hidden');

                            // 3秒后自动隐藏通知
                            setTimeout(() => {
                                pasteNotification.classList.add('hidden');
                            }, 3000);
                        } catch (error) {
                            showUploadError(error.message);
                        }

                        return;
                    }
                }
            }

            // 如果有 pendingImage 但粘贴的是文本，清除 pendingImage
            if (pendingImage && items.length > 0 && items[0].kind === 'string') {
                pendingImage = null;
                pasteNotification.classList.add('hidden');

                // 触发输入事件，发送正在输入状态
                setTimeout(handleInput, 0);
            }
        }

        // 显示上传错误
        function showUploadError(message) {
            errorMessage.textContent = message;
            uploadError.classList.remove('hidden');

            // 5秒后自动隐藏错误提示
            setTimeout(() => {
                uploadError.classList.add('hidden');
            }, 5000);
        }

        // 处理性别选择
        function handleGenderSelection() {
            // 处理用户自身性别选择
            genderOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // 移除所有选项的选中状态
                    genderOptions.forEach(opt => opt.classList.remove('selected'));

                    // 设置当前选项为选中状态
                    option.classList.add('selected');

                    // 保存选中的性别
                    userGender = option.dataset.gender;
                });
            });

            // 处理匹配性别偏好选择
            preferenceOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // 移除所有选项的选中状态
                    preferenceOptions.forEach(opt => opt.classList.remove('selected'));

                    // 设置当前选项为选中状态
                    option.classList.add('selected');

                    // 保存选中的性别偏好
                    genderPreference = option.dataset.preference;
                });
            });
        }

        // 事件监听
        startChatBtn.addEventListener('click', startMatching);

        sendBtn.addEventListener('click', () => {
            sendMessage(messageInput.value.trim());
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(messageInput.value.trim());
            }
        });

        // 监听输入事件，用于发送正在输入状态
        messageInput.addEventListener('input', handleInput);

        cancelMatchBtn.addEventListener('click', cancelMatch);
        endChatBtn.addEventListener('click', endChat);
        imageUpload.addEventListener('change', handleImageUpload);

        // 历史记录相关事件
        historyBtn.addEventListener('click', () => {
            showChatHistoryList();
            historyPanel.classList.toggle('hidden');
        });

        closeHistoryBtn.addEventListener('click', () => {
            historyPanel.classList.add('hidden');
        });

        clearHistoryBtn.addEventListener('click', clearAllChatHistory);

        // 剪切板粘贴事件监听
        document.addEventListener('paste', handlePaste);

        // 语言选择事件
        languageBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            languageDropdown.classList.toggle('hidden');
        });

        languageOptions.forEach(option => {
            option.addEventListener('click', () => {
                const lang = option.dataset.lang;
                setLanguage(lang);
                languageDropdown.classList.add('hidden');
            });
        });

        document.addEventListener('click', () => {
            languageDropdown.classList.add('hidden');
        });

        languageDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // 初始化
        window.addEventListener('load', () => {
            // 初始化性别选择功能
            handleGenderSelection();

            // 检查用户偏好语言
            const savedLang = localStorage.getItem('preferred_language');
            if (savedLang && languages[savedLang]) {
                setLanguage(savedLang);
            } else {
                // 尝试使用浏览器语言
                const browserLang = navigator.language || navigator.userLanguage;
                const langCode = browserLang.split('-')[0]; // 取主要语言代码
                // 检查是否有对应的语言包，没有则使用默认语言
                const supportedLangs = Object.keys(languages);
                const matchedLang = supportedLangs.find(lang => lang.startsWith(langCode)) || 'zh-CN';
                setLanguage(matchedLang);
            }

            initWebSocket();
            initEmojiPicker();
        });




    </script>



    <script src="/js/add_ui.js"> </script>
    <script src="/js/img-zoom.js"> </script>

</body>

</html>