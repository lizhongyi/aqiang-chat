<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>随机匹配聊天</title>
    <!-- 引入Socket.io客户端（核心替换：替换原生WS） -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link rel="stylesheet" href="/css/index.css">
</head>

<body class="bg-gray-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- 语言选择器 -->
        <div class="flex justify-end mb-4">
            <div class="language-selector">
                <button id="language-btn"
                    class="flex items-center gap-2 bg-white px-3 py-1 rounded-md shadow-sm text-sm">
                    <i class="fa fa-globe text-primary"></i>
                    <span id="current-language">中文</span>
                    <i class="fa fa-chevron-down text-xs"></i>
                </button>
                <div id="language-dropdown" class="language-dropdown hidden">
                    <div class="language-option" data-lang="zh-TW">繁体中文</div>
                    <div class="language-option active" data-lang="zh-CN">简体中文</div>
                    <div class="language-option" data-lang="en">English</div>
                    <div class="language-option" data-lang="ja">日本語</div>
                    <div class="language-option" data-lang="ko">한국어</div>
                </div>
            </div>
        </div>

        <!-- 头部 -->
        <header class="text-center mb-8">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-dark mb-2" data-i18n="header.title">随机匹配聊天</h1>
            <p class="text-gray-600" data-i18n="header.subtitle">与陌生人匿名交流，分享你的想法</p>
        </header>

        <!-- 主要内容区 -->
        <main class="flex flex-col lg:flex-row gap-6">
            <!-- 左侧：用户信息、匹配状态和聊天区域 -->
            <div class="lg:w-2/3">
                <!-- 用户信息输入面板 -->
                <div id="user-info-panel" class="bg-white rounded-xl shadow-md p-6 mb-6 text-center">
                    <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gray-200 flex items-center justify-center">
                        <i class="fa fa-user text-4xl text-gray-500"></i>
                    </div>
                    <h2 class="text-xl font-semibold mb-4" data-i18n="userInfo.title">请完善你的信息</h2>
                    <div class="max-w-xs mx-auto">
                        <!-- 昵称输入 -->
                        <input type="text" id="nickname-input" placeholder="例如：阳光男孩、快乐小天使"
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                            data-i18n-placeholder="userInfo.placeholder">

                        <!-- 自身性别选择 -->
                        <div class="mb-6">
                            <p class="text-sm text-gray-500 mb-3 text-left" data-i18n="userInfo.myGender">你的性别：</p>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="gender-option border rounded-lg px-3 py-2 text-center" data-gender="male">
                                    <i class="fa fa-mars block mb-1"></i>
                                    <span data-i18n="userInfo.genderMale">男性</span>
                                </div>
                                <div class="gender-option border rounded-lg px-3 py-2 text-center" data-gender="female">
                                    <i class="fa fa-venus block mb-1"></i>
                                    <span data-i18n="userInfo.genderFemale">女性</span>
                                </div>
                                <div class="gender-option selected border rounded-lg px-3 py-2 text-center"
                                    data-gender="unknown">
                                    <i class="fa fa-question block mb-1"></i>
                                    <span data-i18n="userInfo.genderUnknown">保密</span>
                                </div>
                            </div>
                        </div>

                        <!-- 匹配性别偏好选择 -->
                        <div class="mb-6">
                            <p class="text-sm text-gray-500 mb-3 text-left" data-i18n="userInfo.genderPreference">
                                希望匹配的性别：</p>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="gender-option selected border rounded-lg px-3 py-2 text-center"
                                    data-preference="any">
                                    <i class="fa fa-asterisk block mb-1"></i>
                                    <span data-i18n="userInfo.preferenceAny">不限</span>
                                </div>
                                <div class="gender-option border rounded-lg px-3 py-2 text-center"
                                    data-preference="male">
                                    <i class="fa fa-mars block mb-1"></i>
                                    <span data-i18n="userInfo.preferenceMale">男性</span>
                                </div>
                                <div class="gender-option border rounded-lg px-3 py-2 text-center"
                                    data-preference="female">
                                    <i class="fa fa-venus block mb-1"></i>
                                    <span data-i18n="userInfo.preferenceFemale">女性</span>
                                </div>
                            </div>
                        </div>

                        <p class="text-sm text-gray-500 mb-4" data-i18n="userInfo.hint">信息仅用于匹配，不会公开显示</p>
                        <button id="start-chat-btn"
                            class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition duration-300 w-full"
                            data-i18n="userInfo.button">
                            开始匹配聊天
                        </button>
                    </div>
                </div>

                <!-- 匹配状态面板 -->
                <div id="match-panel" class="hidden bg-white rounded-xl shadow-md p-6 mb-6 text-center">
                    <div
                        class="w-16 h-16 mx-auto mb-4 border-4 border-primary border-t-transparent rounded-full animate-spin">
                    </div>
                    <h2 class="text-xl font-semibold mb-2" data-i18n="match.status">正在寻找聊天对象...</h2>
                    <p class="text-gray-600 mb-4" data-i18n="match.hint">请稍候，我们正在为你匹配合适的聊天伙伴</p>
                    <button id="cancel-match"
                        class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition duration-300"
                        data-i18n="match.cancel">
                        取消匹配
                    </button>
                </div>

                <!-- 聊天面板（默认隐藏） -->
                <div id="chat-panel" class="hidden bg-white rounded-xl shadow-md overflow-hidden">
                    <!-- 聊天头部 -->
                    <div class="bg-primary text-white p-4 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center">
                                <i class="fa fa-user text-gray-700"></i>
                            </div>
                            <span id="partner-nickname" data-i18n="chat.partner">匿名聊天伙伴</span>
                        </div>
                        <div class="flex gap-3">
                            <button id="history-btn" class="text-white hover:text-gray-200 transition" title="聊天历史">
                                <i class="fa fa-history"></i>
                            </button>
                            <button id="clear-history-btn" class="text-white hover:text-gray-200 transition"
                                title="清除历史">
                                <i class="fa fa-trash"></i>
                            </button>
                            <button id="end-chat" class="text-white hover:text-red-200 transition" title="结束聊天">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 聊天历史记录面板（默认隐藏） -->
                    <div id="history-panel" class="hidden bg-gray-50 p-4 border-b">
                        <h3 class="font-semibold mb-2" data-i18n="history.title">聊天历史</h3>
                        <div id="history-list" class="max-h-32 overflow-y-auto space-y-2 text-sm">
                            <!-- 历史记录会动态添加到这里 -->
                        </div>
                        <button id="close-history" class="mt-2 text-primary text-sm hover:underline"
                            data-i18n="history.close">关闭历史</button>
                    </div>

                    <!-- 聊天内容区 -->
                    <div id="chat-messages" class="h-[400px] p-4 overflow-y-auto scrollbar-hide space-y-4">
                        <!-- 消息会动态添加到这里 -->
                        <div id="typing-indicator" class="hidden flex justify-start">
                            <div
                                class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0 mt-1 mr-2">
                                <i class="fa fa-user text-gray-700"></i>
                            </div>
                            <div class="typing-indicator">
                                <span id="typing-text" data-i18n="chat.typing">对方正在输入...</span>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 输入区 -->
                    <div class="border-t p-4">
                        <div class="flex gap-2 mb-2">
                            <button id="emoji-btn" class="text-gray-600 hover:text-primary transition p-2" title="表情">
                                <i class="fa fa-smile-o text-xl"></i>
                            </button>
                            <label for="image-upload"
                                class="text-gray-600 hover:text-primary transition p-2 cursor-pointer" title="上传图片">
                                <i class="fa fa-picture-o text-xl"></i>
                            </label>
                            <input id="image-upload" type="file" accept="image/*" class="hidden">
                            <div class="ml-auto text-xs text-gray-500 flex items-center">
                                <i class="fa fa-clipboard mr-1"></i>
                                <span data-i18n="chat.pasteHint">支持粘贴图片 (Ctrl+V)</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="message-input" placeholder="输入消息... 可粘贴图片(Ctrl+V)"
                                class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                data-i18n-placeholder="chat.inputPlaceholder">
                            <button id="send-btn"
                                class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition"
                                data-i18n="chat.sendBtn">
                                <i class="fa fa-paper-plane"></i>
                            </button>
                        </div>
                        <!-- 上传进度条 -->
                        <div id="upload-progress-container" class="hidden upload-progress">
                            <div id="progress-bar" class="progress-bar"></div>
                        </div>
                        <!-- 粘贴提示（默认隐藏） -->
                        <div id="paste-notification"
                            class="hidden mt-2 text-sm text-green-600 flex items-center justify-center paste-hint">
                            <i class="fa fa-check-circle mr-1"></i>
                            <span data-i18n="chat.pasteSuccess">图片已准备好，点击发送</span>
                        </div>
                        <!-- 上传错误提示 -->
                        <div id="upload-error"
                            class="hidden mt-2 text-sm text-red-600 flex items-center justify-center">
                            <i class="fa fa-exclamation-circle mr-1"></i>
                            <span id="error-message" data-i18n="chat.uploadError">图片上传失败，请重试</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：聊天规则和提示 -->
            <div class="lg:w-1/3">
                <div class="bg-white rounded-xl shadow-md p-6 h-full">
                    <h3 class="text-lg font-semibold mb-4 text-primary" data-i18n="rules.title">聊天规则</h3>
                    <ul class="space-y-2 text-gray-700 mb-6">
                        <li class="flex items-start gap-2">
                            <i class="fa fa-check-circle text-secondary mt-1"></i>
                            <span data-i18n="rules.rule1">保持友好和尊重的交流态度</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fa fa-check-circle text-secondary mt-1"></i>
                            <span data-i18n="rules.rule2">禁止发送违法或不适当内容</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fa fa-check-circle text-secondary mt-1"></i>
                            <span data-i18n="rules.rule3">保护个人隐私，不要分享敏感信息</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fa fa-check-circle text-secondary mt-1"></i>
                            <span data-i18n="rules.rule4">如遇不当内容，可随时结束聊天</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fa fa-check-circle text-secondary mt-1"></i>
                            <span data-i18n="rules.rule5">聊天记录保存在本地，不会上传到服务器</span>
                        </li>
                    </ul>

                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium text-primary mb-2" data-i18n="shortcuts.title">快捷操作</h4>
                        <p class="text-sm text-gray-600 mb-2" data-i18n="shortcuts.paste">•
                            粘贴图片：使用Ctrl+V（Windows）或Cmd+V（Mac）</p>
                        <p class="text-sm text-gray-600" data-i18n="shortcuts.send">• 发送消息：按Enter键</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- 页脚 -->
        <footer class="mt-12 text-center text-gray-500 text-sm" data-i18n="footer.copyright">
            随机匹配聊天 © 2023 - 保持友好交流
        </footer>
    </div>

    <!-- 表情选择器（默认隐藏） -->
    <div id="emoji-picker" class="hidden fixed bg-white rounded-lg shadow-lg p-3 z-50">
        <div class="grid grid-cols-7 gap-2">
            <!-- 表情会动态添加到这里 -->
        </div>
    </div>

    <!-- 图片预览模态框 -->
    <div id="image-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
        <button id="close-modal"
            class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300 transition-colors">
            <i class="fa fa-times"></i>
        </button>
        <img id="modal-image" src="" alt="放大查看"
            class="max-w-full max-h-[90vh] object-contain transition-all duration-300">
    </div>

    <script src="/js/i18n.js"></script>
    <script>
        // ======================== 全局变量 ========================
        // Socket.io实例（核心替换：替代原生WebSocket）
        let socket;
        let currentChatId = null;    // 当前聊天会话ID
        let userNickname = '';       // 当前用户昵称
        let userGender = 'unknown';  // 用户自身性别（默认保密）
        let genderPreference = 'any';// 性别匹配偏好（默认不限）
        let pendingImage = null;     // 待发送的图片URL
        let typingTimer = null;      // 输入定时器
        let isTyping = false;        // 是否正在输入
        const TYPING_DELAY = 1000;   // 输入状态发送间隔(ms)
        const TYPING_TIMEOUT = 2000; // 输入状态超时时间(ms)
        let typingTimeoutTimer = null;// 输入状态超时定时器
        const STORAGE_KEY = 'chat_history'; // 本地存储键名
        let currentLang = 'zh-CN';   // 默认语言
        // 新增：聊天状态本地存储键（用于断线重连）
        const CHAT_STATE_KEY = 'active_chat_state';

        // ======================== DOM元素获取 ========================
        const userInfoPanel = document.getElementById('user-info-panel');
        const nicknameInput = document.getElementById('nickname-input');
        const startChatBtn = document.getElementById('start-chat-btn');
        const matchPanel = document.getElementById('match-panel');
        const chatPanel = document.getElementById('chat-panel');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const cancelMatchBtn = document.getElementById('cancel-match');
        const endChatBtn = document.getElementById('end-chat');
        const emojiBtn = document.getElementById('emoji-btn');
        const emojiPicker = document.getElementById('emoji-picker');
        const imageUpload = document.getElementById('image-upload');
        const historyBtn = document.getElementById('history-btn');
        const historyPanel = document.getElementById('history-panel');
        const historyList = document.getElementById('history-list');
        const closeHistoryBtn = document.getElementById('close-history');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const partnerNickname = document.getElementById('partner-nickname');
        const pasteNotification = document.getElementById('paste-notification');
        const uploadProgressContainer = document.getElementById('upload-progress-container');
        const progressBar = document.getElementById('progress-bar');
        const uploadError = document.getElementById('upload-error');
        const errorMessage = document.getElementById('error-message');
        const typingIndicator = document.getElementById('typing-indicator');
        const typingText = document.getElementById('typing-text');
        const languageBtn = document.getElementById('language-btn');
        const currentLanguage = document.getElementById('current-language');
        const languageDropdown = document.getElementById('language-dropdown');
        const languageOptions = document.querySelectorAll('.language-option');
        const genderOptions = document.querySelectorAll('[data-gender]');
        const preferenceOptions = document.querySelectorAll('[data-preference]');

        // ======================== 新增：聊天状态本地存储管理（核心重连依赖） ========================
        /**
         * 保存聊天状态到localStorage（断线后恢复用）
         * @param {Object} state - 聊天状态（chatId、伙伴信息、用户信息）
         */
        function saveChatStateToLocal(state) {
            if (!state || !state.chatId) return;
            localStorage.setItem(CHAT_STATE_KEY, JSON.stringify({
                ...state,
                updatedAt: Date.now() // 记录更新时间，避免过期状态
            }));
        }

        /**
         * 从localStorage读取聊天状态
         * @returns {Object|null} 有效状态或null（超时/解析失败返回null）
         */
        function getChatStateFromLocal() {
            const stateStr = localStorage.getItem(CHAT_STATE_KEY);
            if (!stateStr) return null;
            
            try {
                const state = JSON.parse(stateStr);
                // 超时判断（30分钟未恢复视为失效）
                const TIMEOUT = 30 * 60 * 1000;
                if (Date.now() - state.updatedAt > TIMEOUT) {
                    clearChatStateFromLocal();
                    return null;
                }
                return state;
            } catch (error) {
                console.error('解析聊天状态失败:', error);
                clearChatStateFromLocal();
                return null;
            }
        }

        /**
         * 清除本地聊天状态（仅主动结束聊天时调用）
         */
        function clearChatStateFromLocal() {
            localStorage.removeItem(CHAT_STATE_KEY);
            clearChatMatchInfo(); // 清除原有匹配信息
        }

        // ======================== 语言处理 ========================
        function setLanguage(lang) {
            if (!languages[lang]) return;

            currentLang = lang;
            currentLanguage.textContent = languageNames[lang] || lang;

            // 更新语言选项活跃状态
            languageOptions.forEach(option => {
                option.classList.toggle('active', option.dataset.lang === lang);
            });

            // 翻译页面文本
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = languages[lang][key] || el.textContent;
            });

            // 翻译占位符
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = languages[lang][key] || el.placeholder;
            });

            // 保存语言偏好
            localStorage.setItem('preferred_language', lang);
            updateDynamicContent();
        }

        function updateDynamicContent() {
            // 更新历史记录空状态
            if (historyList.innerHTML.includes('暂无聊天历史')) {
                historyList.innerHTML = `<p class="text-gray-500">${languages[currentLang]['system.noHistory'] || '暂无聊天历史'}</p>`;
            }
        }

        // ======================== 新增：会话验证（断线重连核心） ========================
        /**
         * 向服务器验证chatId是否有效，有效则恢复聊天
         * @param {string} chatId - 待验证的聊天会话ID
         */
        function verifyChatSession(chatId) {
            if (!socket.connected) return;

            // 发送验证请求（需服务器配合实现verify_chat事件）
            socket.emit('verify_chat', { chatId }, (response) => {
                if (response.success && response.chatInfo) {
                    const { partnerNickname: pNick, partnerGender, userInfo } = response.chatInfo;
                    
                    // 恢复全局状态
                    currentChatId = chatId;
                    userNickname = userInfo.nickname;
                    userGender = userInfo.gender;
                    genderPreference = userInfo.genderPreference;

                    // 切换UI到聊天面板
                    userInfoPanel.classList.add('hidden');
                    matchPanel.classList.add('hidden');
                    chatPanel.classList.remove('hidden');

                    // 更新伙伴昵称（显示性别）
                    const genderText = getGenderDisplayText(partnerGender);
                    partnerNickname.textContent = `${pNick}（${genderText}）`;

                    // 提示恢复成功
                    addSystemMessage(languages[currentLang]['system.chatRestored'] || '已恢复之前的聊天会话');
                    
                    // 加载历史记录
                    loadChatHistory(currentChatId);

                    // 重新保存最新状态（更新时间戳）
                    saveChatStateToLocal({
                        chatId,
                        partnerNickname: pNick,
                        partnerGender,
                        userInfo: { nickname: userNickname, gender: userGender, genderPreference }
                    });

                    // 恢复输入框可用性
                    sendBtn.disabled = false;
                    messageInput.disabled = false;
                } else {
                    // 验证失败：清除本地残留，显示初始面板
                    clearChatStateFromLocal();
                    userInfoPanel.classList.remove('hidden');
                    addSystemMessage(response.message || languages[currentLang]['system.chatExpired'] || '聊天会话已失效，请重新匹配');
                }
            });
        }

        // 新增：性别显示文本转换（匹配成功/恢复时用）
        function getGenderDisplayText(genderCode) {
            switch (genderCode) {
                case 'male': return languages[currentLang]['userInfo.genderMale'] || '男性';
                case 'female': return languages[currentLang]['userInfo.genderFemale'] || '女性';
                default: return languages[currentLang]['userInfo.genderUnknown'] || '保密';
            }
        }

        // ======================== Socket.io初始化（核心替换：新增重连逻辑） ========================
        function initSocketIO() {
            // Socket.io自动处理协议（http->ws，https->wss）和重连
            socket = io();

            // 连接成功回调（新增：优先尝试恢复会话）
            socket.on('connect', () => {
                console.log('Socket.io连接成功，连接ID:', socket.id);
                addSystemMessage(languages[currentLang]['system.connected'] || '已成功连接到聊天服务器');

                // 新增：连接成功后检查本地是否有未结束的聊天
                const savedChatState = getChatStateFromLocal();
                if (savedChatState && savedChatState.chatId) {
                    verifyChatSession(savedChatState.chatId);
                } else if (!currentChatId && !matchPanel.classList.contains('hidden')) {
                    // 无保存状态，但之前在匹配中：重新发起匹配
                    socket.emit('match_request', {
                        nickname: userNickname,
                        gender: userGender,
                        genderPreference: genderPreference
                    });
                }
            });

            // 接收服务器事件（按业务拆分，清晰易懂）
            socket.on('match_found', (data) => {
                handleMessage({ type: 'match_found', ...data });
            });
            socket.on('new_message', (data) => {
                handleMessage({ type: 'message', ...data });
            });
            socket.on('typing_status', (data) => {
                handleMessage({ type: 'typing', ...data });
            });
            socket.on('user_disconnected', (data) => {
                handleMessage({ type: 'user_disconnected', ...data });
            });
            socket.on('system_message', (data) => {
                handleMessage({ type: 'system', ...data });
            });

            // 连接断开（Socket.io会自动重连）
            socket.on('disconnect', (reason) => {
                console.log('Socket.io连接断开，原因:', reason);
                addSystemMessage(languages[currentLang]['system.disconnected'] || '与服务器断开连接，正在重试...');
            });

            // 连接错误
            socket.on('error', (error) => {
                console.error('Socket.io错误:', error);
                addSystemMessage(languages[currentLang]['system.socketError'] || '连接出错，请稍候重试');
            });
        }

        // ======================== 聊天消息处理 ========================
        function addMessage(content, isOwn, isImage = false, senderNickname) {
            // 隐藏输入提示
            if (!isOwn) hideTypingIndicator();

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} gap-2`;

            // 头像
            const avatarDiv = document.createElement('div');
            avatarDiv.className = `w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0 mt-1`;
            avatarDiv.innerHTML = `<i class="fa fa-user text-gray-700"></i>`;

            // 消息容器
            const bubbleContainer = document.createElement('div');
            bubbleContainer.className = 'flex flex-col max-w-[70%]';

            // 对方昵称显示
            if (!isOwn && senderNickname) {
                const nicknameDiv = document.createElement('div');
                nicknameDiv.className = 'text-xs text-gray-500 mb-1 ml-1';
                nicknameDiv.textContent = senderNickname;
                bubbleContainer.appendChild(nicknameDiv);
            }

            // 消息气泡
            const bubbleClass = isOwn
                ? 'bg-primary text-white rounded-t-lg rounded-bl-lg'
                : 'bg-gray-200 text-gray-800 rounded-t-lg rounded-br-lg';
            const messageContent = document.createElement('div');
            messageContent.className = `${bubbleClass} px-4 py-2`;

            // 图片/文本内容
            if (isImage) {
                const imageUrl = content.startsWith('http') ? content : `${window.location.origin}${content}`;
                messageContent.innerHTML = `<img src="${imageUrl}" alt="聊天图片" class="chat-image rounded max-w-full h-auto">`;
            } else {
                messageContent.textContent = content;
            }

            bubbleContainer.appendChild(messageContent);

            // 组装消息（保留输入提示节点）
            if (isOwn) {
                messageDiv.appendChild(bubbleContainer);
                messageDiv.appendChild(avatarDiv);
            } else {
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(bubbleContainer);
            }

            // 插入到输入提示前（避免消息被覆盖）
            if (chatMessages.contains(typingIndicator)) {
                chatMessages.insertBefore(messageDiv, typingIndicator);
            } else {
                chatMessages.appendChild(messageDiv);
                chatMessages.appendChild(typingIndicator);
            }

            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMessage(content) {
            hideTypingIndicator();

            const systemDiv = document.createElement('div');
            systemDiv.className = 'text-center';

            const messageContent = document.createElement('div');
            messageContent.className = 'inline-block bg-gray-100 text-gray-500 text-sm px-3 py-1 rounded-full';
            messageContent.textContent = content;

            systemDiv.appendChild(messageContent);

            // 插入消息（保留输入提示）
            if (chatMessages.contains(typingIndicator)) {
                chatMessages.insertBefore(systemDiv, typingIndicator);
            } else {
                chatMessages.appendChild(systemDiv);
                chatMessages.appendChild(typingIndicator);
            }

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            typingText.textContent = languages[currentLang]['chat.typing'] || '对方正在输入...';
            typingIndicator.classList.remove('hidden');

            // 输入超时自动隐藏
            clearTimeout(typingTimeoutTimer);
            typingTimeoutTimer = setTimeout(hideTypingIndicator, TYPING_TIMEOUT);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            typingIndicator.classList.add('hidden');
            clearTimeout(typingTimeoutTimer);
        }

        // ======================== 消息发送（Socket.io事件） ========================
        function sendMessage(content, isImage = false) {
            if (!socket.connected || !currentChatId) return;

            // 发送消息时停止输入状态
            sendTypingStatus(false);

            // 优先发送待传图片
            if (pendingImage) {
                const messageData = {
                    content: pendingImage,
                    isImage: true,
                    chatId: currentChatId,
                    senderNickname: userNickname,
                    timestamp: new Date().toISOString()
                };

                // 发送Socket.io事件
                socket.emit('new_message', messageData);
                addMessage(pendingImage, true, true, userNickname);
                saveMessageToHistory(currentChatId, pendingImage, true, true, userNickname);

                // 清除待传图片
                pendingImage = null;
                pasteNotification.classList.add('hidden');
                return;
            }

            // 发送文本消息
            if (content.trim()) {
                const messageData = {
                    content: content,
                    isImage: false,
                    chatId: currentChatId,
                    senderNickname: userNickname,
                    timestamp: new Date().toISOString()
                };

                socket.emit('new_message', messageData);
                addMessage(content, true, false, userNickname);
                saveMessageToHistory(currentChatId, content, true, false, userNickname);
                messageInput.value = '';
            }
        }

        function sendTypingStatus(status) {
            if (!socket.connected || !currentChatId || isTyping === status) return;

            isTyping = status;
            // 发送输入状态事件
            socket.emit('typing_status', {
                isTyping: status,
                chatId: currentChatId,
                senderNickname: userNickname
            });
        }

        function handleInput() {
            // 有待传图片时不发送输入状态
            if (pendingImage) return;

            clearTimeout(typingTimer);
            if (!isTyping) sendTypingStatus(true);

            // 超时后发送停止输入状态
            typingTimer = setTimeout(() => {
                sendTypingStatus(false);
            }, TYPING_TIMEOUT);
        }

        // ======================== 匹配逻辑（新增：匹配成功保存状态） ========================
        function startMatching() {
            const nickname = nicknameInput.value.trim();
            if (!nickname) {
                showCustomAlert('', languages[currentLang]['userInfo.nicknameRequired'] || '请输入你的昵称');
                return;
            }

            userNickname = nickname;
            userInfoPanel.classList.add('hidden');
            matchPanel.classList.remove('hidden');

            // 显示偏好匹配提示
            if (genderPreference !== 'any') {
                addSystemMessageToMatchPanel(
                    languages[currentLang]['system.matchingInfo'] || '正在根据你的性别偏好匹配聊天对象...'
                );
            }

            // 发送匹配请求（Socket.io事件）
            if (socket.connected) {
                socket.emit('match_request', {
                    nickname: userNickname,
                    gender: userGender,
                    genderPreference: genderPreference
                });
            } else {
                // 连接中提示重试
                addSystemMessageToMatchPanel(
                    languages[currentLang]['system.notConnected'] || '正在连接服务器，请稍候...'
                );
                setTimeout(() => {
                    if (socket.connected) {
                        socket.emit('match_request', {
                            nickname: userNickname,
                            gender: userGender,
                            genderPreference: genderPreference
                        });
                    }
                }, 1500);
            }
        }

        function cancelMatch() {
            // 发送取消匹配事件
            if (socket.connected) {
                socket.emit('cancel_match', { nickname: userNickname });
            }

            // 清理状态
            const systemMessage = matchPanel.querySelector('.system-message');
            if (systemMessage) systemMessage.remove();

            matchPanel.classList.add('hidden');
            userInfoPanel.classList.remove('hidden');
        }

        // 新增：修改endChat，主动结束时清除本地状态
        function endChat() {
            // 发送停止输入状态
            sendTypingStatus(false);

            // 发送结束聊天事件
            if (socket.connected && currentChatId) {
                socket.emit('end_chat', {
                    chatId: currentChatId,
                    nickname: userNickname
                });
            }

            // 新增：主动结束时清除本地聊天状态
            clearChatStateFromLocal();

            // 重置界面状态
            chatPanel.classList.add('hidden');
            userInfoPanel.classList.remove('hidden');

            // 保留输入提示节点，清空其他消息
            while (chatMessages.firstChild) {
                if (chatMessages.firstChild === typingIndicator) break;
                chatMessages.removeChild(chatMessages.firstChild);
            }

            // 重置变量
            sendBtn.disabled = false;
            messageInput.disabled = false;
            currentChatId = null;
            pendingImage = null;
            pasteNotification.classList.add('hidden');
            uploadProgressContainer.classList.add('hidden');
            uploadError.classList.add('hidden');
            hideTypingIndicator();
        }

        // ======================== 图片处理 ========================
        async function uploadImageToServer(file) {
            return new Promise((resolve, reject) => {
                uploadProgressContainer.classList.remove('hidden');
                progressBar.style.width = '0%';
                uploadError.classList.add('hidden');

                // 上传时停止输入状态
                sendTypingStatus(false);

                const formData = new FormData();
                formData.append('image', file);

                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/upload', true);

                // 上传进度
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        progressBar.style.width = `${(e.loaded / e.total) * 100}%`;
                    }
                });

                xhr.onload = () => {
                    uploadProgressContainer.classList.add('hidden');
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.success && response.imageUrl) {
                                resolve(response.imageUrl);
                            } else {
                                reject(new Error(response.message || languages[currentLang]['chat.uploadError']));
                            }
                        } catch (error) {
                            reject(new Error(languages[currentLang]['chat.uploadError']));
                        }
                    } else {
                        reject(new Error(languages[currentLang]['chat.uploadError']));
                    }
                };

                xhr.onerror = () => {
                    uploadProgressContainer.classList.add('hidden');
                    reject(new Error(languages[currentLang]['chat.uploadError']));
                };

                xhr.send(formData);
            });
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) {
                showUploadError(languages[currentLang]['chat.invalidImage'] || '请选择有效的图片文件');
                return;
            }

            try {
                const imageUrl = await uploadImageToServer(file);
                pendingImage = imageUrl;
                pasteNotification.classList.remove('hidden');
                setTimeout(() => pasteNotification.classList.add('hidden'), 3000);
            } catch (error) {
                showUploadError(error.message);
            } finally {
                imageUpload.value = ''; // 重置输入
            }
        }

        async function handlePaste(event) {
            if (chatPanel.classList.contains('hidden')) return;

            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            for (let item of items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    event.preventDefault();
                    const file = item.getAsFile();

                    try {
                        const imageUrl = await uploadImageToServer(file);
                        pendingImage = imageUrl;
                        pasteNotification.classList.remove('hidden');
                        setTimeout(() => pasteNotification.classList.add('hidden'), 3000);
                    } catch (error) {
                        showUploadError(error.message);
                    }
                    return;
                }
            }

            // 粘贴文本时清除待传图片
            if (pendingImage && items.length > 0 && items[0].kind === 'string') {
                pendingImage = null;
                pasteNotification.classList.add('hidden');
                setTimeout(handleInput, 0);
            }
        }

        function showUploadError(message) {
            errorMessage.textContent = message;
            uploadError.classList.remove('hidden');
            setTimeout(() => uploadError.classList.add('hidden'), 5000);
        }

        // ======================== 本地存储 ========================
        function getChatHistory() {
            const history = localStorage.getItem(STORAGE_KEY);
            return history ? JSON.parse(history) : {};
        }

        function saveChatHistory(history) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        }

        function saveMessageToHistory(chatId, content, isOwn, isImage, senderNickname) {
            const history = getChatHistory();
            if (!history[chatId]) {
                history[chatId] = {
                    timestamp: new Date().toISOString(),
                    partnerNickname: partnerNickname.textContent,
                    messages: []
                };
            }

            history[chatId].messages.push({
                content, isOwn, isImage, senderNickname,
                timestamp: new Date().toISOString()
            });

            saveChatHistory(history);
        }

        function loadChatHistory(chatId) {
            const history = getChatHistory()[chatId];
            if (history && history.messages.length > 0) {
                addSystemMessage(languages[currentLang]['system.loadingHistory'] || '正在加载历史记录...');
                history.messages.forEach(msg => {
                    addMessage(msg.content, msg.isOwn, msg.isImage, msg.senderNickname);
                });
                addSystemMessage(languages[currentLang]['system.historyLoaded'] || '历史记录加载完成');
            }
        }

        function showChatHistoryList() {
            const history = getChatHistory();
            historyList.innerHTML = '';

            // 按时间排序会话
            const chatSessions = Object.entries(history)
                .map(([id, data]) => ({ id, ...data }))
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (chatSessions.length === 0) {
                historyList.innerHTML = `<p class="text-gray-500">${languages[currentLang]['system.noHistory'] || '暂无聊天历史'}</p>`;
                return;
            }

            chatSessions.forEach(session => {
                const item = document.createElement('div');
                item.className = 'p-2 border-b border-gray-100 last:border-0 hover:bg-gray-100 rounded cursor-pointer';

                const date = new Date(session.timestamp);
                const lastMsg = session.messages[session.messages.length - 1];
                const msgPreview = lastMsg.isImage 
                    ? '[图片]' 
                    : lastMsg.content.length > 20 
                        ? `${lastMsg.content.substring(0, 20)}...` 
                        : lastMsg.content;

                item.innerHTML = `
                    <div class="font-medium text-sm">与 ${session.partnerNickname} 的聊天</div>
                    <div class="text-xs text-gray-500">${date.toLocaleString()}</div>
                    <div class="text-xs">${lastMsg.isOwn ? '你: ' : `${session.partnerNickname}: `}${msgPreview}</div>
                `;

                item.addEventListener('click', () => {
                    if (currentChatId && currentChatId !== session.id) endChat();
                    currentChatId = session.id;
                    partnerNickname.textContent = session.partnerNickname;
                    userInfoPanel.classList.add('hidden');
                    matchPanel.classList.add('hidden');
                    chatPanel.classList.remove('hidden');
                    chatMessages.innerHTML = '';
                    loadChatHistory(currentChatId);
                    historyPanel.classList.add('hidden');
                });

                historyList.appendChild(item);
            });
        }

        function clearAllChatHistory() {
            showCustomConfirm(
                languages[currentLang]['system.clearHistoryConfirm'] || '确定要清除所有聊天历史吗？',
                () => {
                    localStorage.removeItem(STORAGE_KEY);
                    showChatHistoryList();
                    addSystemMessage(languages[currentLang]['system.historyCleared'] || '所有聊天历史已清除');
                }
            );
        }

        function saveChatMatchInfo(chatId, partnerNickname) {
            localStorage.setItem('chatMatchInfo', JSON.stringify({
                chatId, partnerNickname, timestamp: Date.now()
            }));
        }

        function clearChatMatchInfo() {
            localStorage.removeItem('chatMatchInfo');
        }

        // ======================== 消息处理核心（修改：匹配成功保存状态） ========================
        function handleMessage(data) {
            console.log('收到服务器消息:', data);
            switch (data.type) {
                case 'match_found':
                    // 匹配成功
                    matchPanel.classList.add('hidden');
                    chatPanel.classList.remove('hidden');
                    currentChatId = data.chatId || generateChatId();

                    const partnerName = data.partnerNickname?.trim() || languages[currentLang]['chat.partner'];
                    const partnerGender = data.partnerGender || 'unknown'; // 新增：获取伙伴性别
                    const genderText = getGenderDisplayText(partnerGender);
                    partnerNickname.textContent = `${partnerName}（${genderText}）`;
                    
                    // 显示带性别的匹配消息
                    addSystemMessage(
                        (languages[currentLang]['system.matchFound'] || '11已匹配到聊天伙伴: {name}（性别：{gender}）')
                            .replace('{name}', partnerName)
                            .replace('{gender}', genderText)
                    );

                    // 新增：保存聊天状态到本地（用于断线恢复）
                    saveChatStateToLocal({
                        chatId: currentChatId,
                        partnerNickname: partnerName,
                        partnerGender: partnerGender,
                        userInfo: {
                            nickname: userNickname,
                            gender: userGender,
                            genderPreference: genderPreference
                        }
                    });

                    loadChatHistory(currentChatId);
                    saveChatMatchInfo(currentChatId, partnerName);
                    break;

                case 'message':
                    // 收到新消息
                    hideTypingIndicator();
                    addMessage(data.content, false, data.isImage, data.senderNickname);
                    saveMessageToHistory(currentChatId, data.content, false, data.isImage, data.senderNickname);
                    break;

                case 'typing':
                    // 对方输入状态
                    if (data.chatId === currentChatId) {
                        data.isTyping ? showTypingIndicator() : hideTypingIndicator();
                    }
                    break;

                case 'user_disconnected':
                    // 对方断开连接
                    hideTypingIndicator();
                    addSystemMessage(
                        (languages[currentLang]['system.partnerLeft'] || '聊天伙伴 {name} 已离开').replace('{name}', partnerNickname.textContent)
                    );
                    sendBtn.disabled = true;
                    messageInput.disabled = true;
                    break;

                case 'system':
                    // 系统消息
                    hideTypingIndicator();
                   addSystemMessage(
                        (languages[currentLang][data.messageKey] || data.content)
                    );
                    break;
            }
        }

        // ======================== 工具函数 ========================
        function generateChatId() {
            return `${Math.random().toString(36).slice(2, 15)}${Math.random().toString(36).slice(2, 15)}`;
        }

        function handleGenderSelection() {
            // 自身性别选择
            genderOptions.forEach(option => {
                option.addEventListener('click', () => {
                    genderOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    userGender = option.dataset.gender;
                });
            });

            // 匹配偏好选择
            preferenceOptions.forEach(option => {
                option.addEventListener('click', () => {
                    preferenceOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    genderPreference = option.dataset.preference;
                });
            });
        }

        function addSystemMessageToMatchPanel(content) {
            // 移除已有消息
            const existing = matchPanel.querySelector('.system-message');
            if (existing) existing.remove();

            const msgDiv = document.createElement('div');
            msgDiv.className = 'system-message text-sm text-gray-500 mt-4';
            msgDiv.innerHTML = `<i class="fa fa-info-circle mr-1 text-primary"></i>${content}`;
            matchPanel.appendChild(msgDiv);
        }

        // ======================== 事件监听 ========================
        function initEventListeners() {
            // 开始匹配
            startChatBtn.addEventListener('click', startMatching);

            // 发送消息
            sendBtn.addEventListener('click', () => sendMessage(messageInput.value.trim()));
            messageInput.addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage(messageInput.value.trim()));
            messageInput.addEventListener('input', handleInput);

            // 取消匹配/结束聊天
            cancelMatchBtn.addEventListener('click', cancelMatch);
            endChatBtn.addEventListener('click', endChat);

            // 图片处理
            imageUpload.addEventListener('change', handleImageUpload);
            document.addEventListener('paste', handlePaste);

            // 历史记录
            historyBtn.addEventListener('click', () => {
                showChatHistoryList();
                historyPanel.classList.toggle('hidden');
            });
            closeHistoryBtn.addEventListener('click', () => historyPanel.classList.add('hidden'));
            clearHistoryBtn.addEventListener('click', clearAllChatHistory);

            // 语言选择
            languageBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                languageDropdown.classList.toggle('hidden');
            });
            languageOptions.forEach(option => {
                option.addEventListener('click', () => {
                    setLanguage(option.dataset.lang);
                    languageDropdown.classList.add('hidden');
                });
            });
            document.addEventListener('click', () => languageDropdown.classList.add('hidden'));
            languageDropdown.addEventListener('click', (e) => e.stopPropagation());

            // 表情选择器（假设initEmojiPicker在add_ui.js中）
            emojiBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const rect = emojiBtn.getBoundingClientRect();
                emojiPicker.style.left = `${rect.left}px`;
                emojiPicker.style.top = `${rect.bottom + 5}px`;
                emojiPicker.classList.toggle('hidden');
            });
            document.addEventListener('click', () => emojiPicker.classList.add('hidden'));
            emojiPicker.addEventListener('click', (e) => e.stopPropagation());
        }
 


        // ======  表情

        // 初始化表情选择器
        function initEmojiPicker() {
            const emojis = ['😊', '😂', '😍', '👍', '❤️', '🎉', '🤔', '😢', '😡', '👏', '🙌', '😉', '😎', '🤷‍♂️', '🙏'];
            const emojiContainer = emojiPicker.querySelector('div');

            emojis.forEach(emoji => {
                const emojiBtn = document.createElement('button');
                emojiBtn.className = 'p-2 hover:bg-gray-100 rounded-full transition';
                emojiBtn.textContent = emoji;
                emojiBtn.addEventListener('click', () => {
                    messageInput.value += emoji;
                    messageInput.focus();
                    // 触发输入事件，发送正在输入状态
                    handleInput();
                });
                emojiContainer.appendChild(emojiBtn);
            });

            emojiBtn.addEventListener('click', (e) => {
                console.log('显示表情')
                e.stopPropagation();
                const rect = emojiBtn.getBoundingClientRect();
                emojiPicker.style.top = `${rect.bottom -200}px`;
                emojiPicker.style.left = `${rect.left + window.scrollX}px`;
                //emojiPicker.classList.toggle('hidden');
            });

            document.addEventListener('click', () => {
                emojiPicker.classList.add('hidden');
            });

            emojiPicker.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }      
        // ======================== 页面初始化（修改：移除重复的会话恢复逻辑，Socket连接时已处理） ========================
        window.addEventListener('load', () => {
            // 初始化性别选择
            handleGenderSelection();

            // 初始化语言
            const savedLang = localStorage.getItem('preferred_language');
            if (savedLang && languages[savedLang]) {
                setLanguage(savedLang);
            } else {
                // 自动检测浏览器语言
                const browserLang = navigator.language || navigator.userLanguage;
                const langCode = browserLang.split('-')[0];
                const supportedLangs = Object.keys(languages);
                const matchedLang = supportedLangs.find(lang => lang.startsWith(langCode)) || 'zh-CN';
                setLanguage(matchedLang);
            }

            // 初始化Socket.io（核心替换：连接成功后自动尝试恢复会话）
            initSocketIO();

            // 初始化事件监听
            initEventListeners();

            // 初始化表情选择器（依赖外部JS）
          
            initEmojiPicker();
        });
    </script>
    <script src="/js/add_ui.js"></script>
    <script src="/js/img-zoom.js"></script>
</body>
</html>